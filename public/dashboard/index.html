<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PriceCheck • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="PriceCheck Dashboard: product view with history, cross store offers, variant specs, integrity forensics, observation log, coverage, exports.">
  <link rel="icon" type="image/png" href="../logo/logo.png">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="dashboard-page">
  <!-- Header -->
  <header class="nav">
    <div class="nav__row">
      <div class="logo-head">
        <img src="../logo/logo.png" alt="PriceCheck logo" class="logo">
        <div class="brand">
          <span class="wordmark">PriceCheck</span>
          <span class="edition">0.8.4 Beta</span>
        </div>
      </div>
      <nav class="links" aria-label="Primary">
        <a href="/privacy-policy/">Privacy</a>
        <a class="active" href="/dashboard/">Dashboard</a>
        <a href="../">Overview</a>
        <a href="/research/">Research</a>
        <a href="/insights/">Insights</a>
      </nav>
      <a class="btn btn--outline" href="https://chromewebstore.google.com/detail/pricecheck-your-all-in-on/ikpdkmnglgckdhlkcboeccifjpikcfcf">Add to Chrome</a>
    </div>
  </header>

  <!-- Mobile-only message -->
  <div class="mobile-blocker" role="status" aria-live="polite">
    <div class="mobile-blocker__card">
      <h2>PriceCheck Dashboard is not supported on mobile</h2>
      <p>Please use a desktop browser to view prices, variants, and logs.</p>
    </div>
  </div>

  <main class="wrap">
    <h1>Dashboard Beta</h1>

    <!-- Controls -->
    <section class="card">
      <div class="controls">
        <input id="query" type="search" placeholder="Paste a product URL or enter UPC, ASIN, TCIN, or SKU" aria-label="Product query">
        <button id="load" class="btn">Load</button>
        <button id="share" class="pill">Copy share link</button>
      </div>
      <p class="muted" style="margin-top:6px">
        Examples:
        <button class="pill"
          onclick="document.getElementById('query').value='B0BKVY4WKT';document.getElementById('load').click()">
          Logitech Master 3S
        </button>
        <button class="pill"
          onclick="document.getElementById('query').value='B09BRD98T4';document.getElementById('load').click()">
          Apple Magic Mouse
        </button>
        <button class="pill"
          onclick="document.getElementById('query').value='B0F5HPCLGB';document.getElementById('load').click()">
          Acer OMR266
        </button>
      </p>
    </section>

    <section class="grid-shell" style="margin-top:18px">
      <!-- MAIN -->
      <div>
        <!-- Product header -->
        <section class="card" id="productHeader">
          <div class="grid2">
            <div>
              <h2 id="pTitle">Product Information</h2>
              <p class="muted" id="pSubtitle">Enter a link or ID to start.</p>
              <div class="muted mono" id="pIds"></div>
              <div style="margin-top:10px">
                <label class="muted" for="variant">Variant</label>
                <select id="variant" style="display:block; width:260px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font:inherit"></select>
              </div>
            </div>
            <div>
              <img id="pImg" src="" alt="Product image" style="width:100%; max-width:340px; border-radius:12px; border:1px solid var(--line); display:none">
            </div>
          </div>
        </section>

        <!-- KPIs -->
        <section class="card" style="margin-top:16px">
          <div class="kpis">
            <div class="kpi"><div class="small">Current price</div><div class="big" id="kCurrent">NA</div><div class="small muted" id="kStore"></div></div>
            <div class="kpi"><div class="small">Typical low 90d</div><div class="big" id="kTypical">NA</div><div class="small muted" id="kTypicalNote"></div></div>
            <div class="kpi"><div class="small">30d low</div><div class="big" id="kLow30">NA</div><div class="small muted" id="kLow30Date"></div></div>
            <div class="kpi"><div class="small">Deal integrity</div><div class="big" id="kIntegrity">NA</div><div class="small muted">strike claim status</div></div>
          </div>
        </section>

        <!-- Cross store offers -->
        <section class="card" style="margin-top:16px">
          <div class="spaced">
            <h2 style="margin:0">Cross Offers</h2>
            <div>
              <button class="pill" id="sortTotal">Sort by price</button>
              <button class="pill" id="copyCheapest">Copy cheapest link</button>
            </div>
          </div>
          <div id="offers"></div>
          <p class="muted-note" id="offersNote"></p>
        </section>

           <!-- Price history -->
        <section class="card" style="margin-top:16px">
          <div class="spaced" style="margin-bottom:20px">
            <h2 style="margin:0">Price History</h2>
            <div>
              <button class="pill" data-range="7">7d</button>
              <button class="pill" data-range="30">30d</button>
              <button class="pill" data-range="90">90d</button>
              <button class="pill" id="downloadCsv">Download CSV</button>
            </div>
          </div>
          <svg id="chart" class="chart" viewBox="0 0 700 200" preserveAspectRatio="none" role="img" aria-label="Price history chart"></svg>
          <div class="center" id="chartNote">No history yet</div>
          <div class="legend"><span class="swatch"></span><span class="muted">Current price</span> <span class="swatch alt" style="margin-left:10px"></span><span class="muted">Typical low</span></div>
        </section>

        <!-- Variant Specs Matrix -->
        <section class="card" style="margin-top:16px">
          <h2>Variant Matrix</h2>
          <div class="muted" style="margin-bottom:8px">Differences are highlighted to prevent fake variant deals.</div>
          <div id="specsMatrix">No specs available.</div>
        </section>

        <!-- Deal Integrity Forensics -->
        <section class="card" style="margin-top:16px">
          <h2>Deal Integrity</h2>
          <details id="forensics">
            <summary class="muted">Open details</summary>
            <ul id="forensicsList" class="links-list" style="margin-top:6px"></ul>
          </details>
          <p class="muted-note">We compare claimed strikes to observed history on the exact variant. Bad anchor price or wrong variant gets flagged.</p>
        </section>

        <!-- Observation Log -->
        <section class="card" style="margin-top:16px">
          <div class="spaced">
            <h2 style="margin:0">Observation Log</h2>
            <button class="pill" id="downloadObs">Download log CSV</button>
          </div>
          <table>
            <thead><tr><th>Time</th><th>Store</th><th>Price</th><th>Note</th></tr></thead>
            <tbody id="obsBody"></tbody>
          </table>
          <p class="muted-note">We record per-store price observations with the exact capture time from our servers.</p>
        </section>
      </div>

      <!-- SIDEBAR -->
      <aside>
        <div class="sticky">
          <section class="card">
            <h3>Coverage Snapshot</h3>
            <div class="bars" id="coverage"></div>
            <p class="muted-note">Share is based on lowest total count within last 24h and feed freshness.</p>
          </section>

          <section class="card" style="margin-top:16px">
            <h3>PriceMatch</h3>
            <p class="muted">If eligible, contact the higher priced retailer and use this script.</p>
            <textarea id="pmScript" rows="6" style="width:100%; border:1px solid var(--line); border-radius:10px; padding:10px; font:inherit"></textarea>
            <div class="spaced" style="margin-top:8px">
              <button class="btn" id="copyPm">Copy script</button>
              <span class="muted" id="pmNote"></span>
            </div>
          </section>

          <!-- Intelligence -->
          <section class="card" style="margin-top:16px">
            <h3>PriceCheck Intelligence</h3>
            <p class="muted">Quick actions that save time.</p>
            <div class="grid2" style="margin-top:16px">
              <button class="btn" id="actSummary">Summarize</button>
              <button class="btn" id="actRefund">Post purchase refund</button>
            </div>
            <button class="btn" id="actFlag" style="padding:18px;margin-top:16px;width:100%">Flag a shady listing</button>
            <p class="muted" id="actNote" style="margin-top:6px"></p>
          </section>

          <section class="card" style="margin-top:16px">
            <h3>Notes</h3>
            <ul class="links-list">
              <li>Exact variant matching only. Bundles and open box are shown as tags for clarity.</li>
              <li>Totals are base plus ship plus tax where available. Location can change tax.</li>
              <li>Use the Observation log to debug stale integrators.</li>
            </ul>
          </section>
        </div>
      </aside>
    </section>
  </main>

<script>
(function(){
  const $  = (s, ctx=document)=>ctx.querySelector(s);
  const $$ = (s, ctx=document)=>Array.from(ctx.querySelectorAll(s));
  const fmt = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'});
  const todayLabel = new Intl.DateTimeFormat(undefined,{dateStyle:'medium'}).format(new Date());

  const state = { identity:null, variants:[], offers:[], observed:[], range:30, selectedAsin:null, lastKey:null };


  // Controls
  $('#load').addEventListener('click', ()=> run($('#query').value.trim()));
  $('#share').addEventListener('click', ()=>{
    const text = location.origin + '/dashboard';
    navigator.clipboard.writeText(text);
    flip('#share','Copied','Copy share link',900);
  });
  document.addEventListener('click', (e)=>{
    const r = e.target.closest('[data-range]');
    if(r){ state.range = +r.dataset.range; drawChart(); }
    if(e.target && e.target.id === 'actSummary'){
      const msg = buildSummaryMsg(); if(!msg){ note('Load a product first.'); return; }
      copyText(msg); note('Copied summary.');
    }
    if(e.target && e.target.id === 'actRefund'){
      const msg = buildRefundMsg(); if(!msg){ note('Load a product first.'); return; }
      copyText(msg); note('Copied refund request.');
    }
    if(e.target && e.target.id === 'actFlag'){
      const msg = buildFlagMsg(); if(!msg){ note('Load a product first.'); return; }
      copyText(msg); note('Copied report text.');
    }
  });
  $('#sortTotal').addEventListener('click', ()=> renderOffers(true));
  $('#copyCheapest').addEventListener('click', ()=>{
    const cheap = getCheapestOffer();
    const link = cheap ? (cheap.url || canonicalLink(cheap.store, cheap, state.identity)) : '';
    if(link) navigator.clipboard.writeText(link);
    flip('#copyCheapest','Copied','Copy cheapest link',900);
  });
  $('#downloadCsv').addEventListener('click', downloadHistoryCsv);
  $('#downloadObs').addEventListener('click', downloadObsCsv);
  $('#copyPm').addEventListener('click', ()=>{
    const ta = $('#pmScript');
    ta.select(); document.execCommand('copy');
    $('#pmNote').textContent = 'Copied';
    setTimeout(()=>$('#pmNote').textContent='',900);
  });
  // when user picks a variant, reload that exact ASIN
    $('#variant').addEventListener('change', (e) => {
      const asin = e.target.selectedOptions[0]?.dataset.asin;
      if (asin) {
        state.selectedAsin = asin.toUpperCase(); // remember before reload
        run(`asin:${asin}`);
      }
    });

  function getCurrentVariant(){
    const asin = state.selectedAsin || (state.identity?.asin ? String(state.identity.asin).toUpperCase() : null);
    if (asin) {
      const v = (state.variants || []).find(x => String(x.asin || '').toUpperCase() === asin);
      if (v) return v;
    }
    return (state.variants && state.variants[0]) || null;
  }

  function keyFromInput(text){
    if(!text) return null;
    const am = text.match(/amazon\.com\/.+\/dp\/(\w{10})/i); if(am) return `asin:${am[1]}`;
    const tg = text.match(/target\.com\/.+\/(?:-|A-)?(\d{8})/i); if(tg) return `tcin:${tg[1]}`;
    const bb = text.match(/bestbuy\.com\/.+\/(\d{6,8})/i); if(bb) return `bby:${bb[1]}`;
    const wm = text.match(/walmart\.com\/.+\/(\d{6,12})/i); if(wm) return `wal:${wm[1]}`;
    if(/^\d{12}$/.test(text)) return `upc:${text}`;
    if(/^\w{10}$/.test(text))  return `asin:${text}`;
    return text;
  }

  async function run(raw){
    const key = keyFromInput(raw);
    if(!key){ showMessage('Enter a product URL or ID.'); return; }
    state.lastKey = key; 

    try{
      toggleLoading(true);
      const res = await fetch(`/v1/compare/${encodeURIComponent(key)}`, { headers: { 'Accept': 'application/json' }});
      if(res.status === 404){ showMessage(`No match for "${raw}". Try prefixes like asin:..., upc:..., bby:..., wal:..., tcin:...`); return; }
      if(!res.ok){ showMessage('Server error. Try again.'); return; }
      const data = await res.json(); // { identity, variants, offers, observed }
      state.identity = data.identity || null;
      state.variants = Array.isArray(data.variants) ? data.variants : [];
      state.offers   = Array.isArray(data.offers)   ? data.offers   : [];
      state.observed = Array.isArray(data.observed) ? data.observed : [];

      // set selectedAsin based on what we requested, else from identity
      if (state.lastKey?.toLowerCase().startsWith('asin:')) {
        state.selectedAsin = state.lastKey.slice(5).toUpperCase();
      } else if (state.identity?.asin) {
        state.selectedAsin = String(state.identity.asin).toUpperCase();
      } else {
        state.selectedAsin = null;
      }

      hydrateHeader();
      hydrateKpis();
      drawChart();
      renderOffers(false);
      renderVariants();
      renderSpecsMatrix();
      renderForensics();
      renderObs();
      renderCoverage();
      buildPmScript();
    }catch(err){
      console.error(err);
      showMessage('Network error. Check console.');
    }finally{
      toggleLoading(false);
    }
  }

  function showMessage(msg){
    $('#pTitle').textContent = msg;
    $('#pSubtitle').textContent = '';
    $('#pIds').textContent = '';
    $('#offers').innerHTML = '';
    $('#offersNote').textContent = '';
    $('#obsBody').innerHTML = '';
    $('#coverage').innerHTML = '';
    $('#kCurrent').textContent = 'NA';
    $('#kStore').textContent = '';
    $('#kTypical').textContent = 'NA';
    $('#kLow30').textContent = 'NA';
    $('#kLow30Date').textContent = '';
    $('#kIntegrity').textContent = 'Pass';
    $('#specsMatrix').textContent = 'No specs available.';
    $('#forensicsList').innerHTML = '';
    $('#chart').innerHTML = '';
    $('#chartNote').textContent = 'No history yet';
  }

  function toggleLoading(on){
    const btn = $('#load');
    if(on){ btn.disabled = true; btn.textContent = 'Loading...'; }
    else { btn.disabled = false; btn.textContent = 'Load'; }
  }

  function hydrateHeader(){
  const id = state.identity || {};
  const DEFAULT_IMG = '../content-img/default.webp';

  const variants = state.variants || [];
  const asinU = String(state.selectedAsin || id.asin || '').toUpperCase();

  // Prefer the selected or identified ASIN variant
  const asinVariant =
    variants.find(v => String(v.asin || '').toUpperCase() === asinU) ||
    variants.find(v => v.asin) || // any ASIN-backed variant
    null;

  // Fallback variant to use for image if needed
  const v = asinVariant || variants[0] || null;

  // Title resolution
  let title = null;

  // 1) Prefer ASIN specs: model_name, then model_number
  if (asinVariant) {
    title =
      (asinVariant.model_name && asinVariant.model_name.trim()) ||
      (asinVariant.model_number && asinVariant.model_number.trim()) ||
      null;
  }

  // 2) If the chosen ASIN lacked specs, try any other ASIN variant with specs
  if (!title) {
    const anyAsinWithSpecs = variants.find(x =>
      x.asin && ((x.model_name && x.model_name.trim()) || (x.model_number && x.model_number.trim()))
    );
    if (anyAsinWithSpecs) {
      title =
        (anyAsinWithSpecs.model_name && anyAsinWithSpecs.model_name.trim()) ||
        (anyAsinWithSpecs.model_number && anyAsinWithSpecs.model_number.trim()) ||
        null;
    }
  }

  // 3) Only if there is no ASIN with specs, fall back to labels
  if (!title) {
    const labelFromVariants = variants.map(x => (x.variant_label || '').trim()).find(Boolean);
    const labelFromOffers   = (state.offers || []).map(o => (o.variant_label || '').trim()).find(Boolean);
    title = labelFromVariants || labelFromOffers || 'Cross store offers';
  }

  $('#pTitle').textContent = title;
  $('#pSubtitle').textContent = 'Latest prices for this product';

  const parts = [];
  if (id.upc)  parts.push(`UPC ${id.upc}`);
  if (id.asin) parts.push(`ASIN ${id.asin}`);
  $('#pIds').textContent = parts.join('  •  ');

  // Image with fallback
  const img = $('#pImg');
  const src =
    (v && v.image_url && v.image_url.trim()) ||
    (id && id.image_url && String(id.image_url).trim()) ||
    DEFAULT_IMG;

  if (src) {
    img.src = src;
    img.alt = title ? `${title} image` : 'Product image';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.style.display = 'block';
    img.onerror = () => { img.style.display = 'none'; };
  } else {
    img.removeAttribute('src');
    img.style.display = 'none';
  }
}

  function cheapestOfferWithPrice(){
    const arr = (state.offers||[]).filter(o => typeof o.price_cents === 'number');
    if(!arr.length) return null;
    return arr.sort((a,b)=>a.price_cents - b.price_cents)[0];
  }

  function buildPmScript(){
    if(!state || !state.identity){
      const ta = document.getElementById('pmScript');
      if(ta) ta.value = 'Load a product first.';
      return;
    }
    const priced = (state.offers || [])
      .filter(o => typeof o.price_cents === 'number')
      .sort((a,b) => a.price_cents - b.price_cents);

    const cheap = priced[0] || null;
    const higher = priced.find(o => cheap ? o.store !== cheap.store : false) || priced[1] || null;
    const id = state.identity || {};
    const money = v => fmt.format((v || 0) / 100);
    const cheapLink = cheap ? (cheap.url || canonicalLink(cheap.store, cheap, id) || '') : '';

    const script = cheap ? (
`Hello, I would like a price match.

${titleCase(cheap.store || 'Retailer')} is offering the same product for ${money(cheap.price_cents)}${cheapLink ? ` (${cheapLink})` : ''}
Your price: ${higher && typeof higher.price_cents === 'number' ? money(higher.price_cents) : 'NA'}

Identifiers: UPC ${id.upc || 'NA'}  ASIN ${id.asin || 'NA'}

This is the same variant. Please match this price. Thank you.`
    ) : 'Load offers to generate a script.';

    const ta = document.getElementById('pmScript');
    if(ta) ta.value = script;
  }

  function hydrateKpis(){
    const best = cheapestOfferWithPrice();
    if(best){
      $('#kCurrent').textContent = fmt.format(best.price_cents/100);
      $('#kStore').textContent = `at ${titleCase(best.store || 'Retailer')}`;
      $('#kTypical').textContent = fmt.format(best.price_cents/100);
      $('#kLow30').textContent = fmt.format(best.price_cents/100);
    }else{
      $('#kCurrent').textContent = 'NA';
      $('#kStore').textContent = '';
      $('#kTypical').textContent = 'NA';
      $('#kLow30').textContent = 'NA';
      $('#kLow30Date').textContent = '';
    }
    $('#kIntegrity').textContent = 'Pass';
  }

  function drawChart(){
    const svg = $('#chart'); svg.innerHTML = '';
    $('#chartNote').textContent = 'No history yet';
  }

  function canonicalLink(store, offer, identity){
    const st = String(store||'').toLowerCase();
    const sku = String(offer?.store_sku||'').trim();
    if(st === 'amazon'){
      const asin = identity?.asin || sku;
      return asin && /^[A-Z0-9]{10}$/i.test(asin) ? `https://www.amazon.com/dp/${asin}` : '';
        }
    if(st === 'best buy' || st === 'bestbuy'){
      return /^\d{6,8}$/.test(sku) ? `https://www.bestbuy.com/site/${sku}.p` : '';
    }
    if(st === 'walmart'){
      return /^\d{6,12}$/.test(sku) ? `https://www.walmart.com/ip/${sku}` : '';
    }
    if(st === 'target'){
      return /^\d{8}$/.test(sku) ? `https://www.target.com/p/-/A-${sku}` : '';
    }
    return '';
  }

  function renderOffers(sortByPrice){
    const wrap = $('#offers'); wrap.innerHTML = '';
    const note = $('#offersNote');

    if(!state.offers.length){
      note.textContent = 'No offers found.';
      return;
    }
    let arr = state.offers.map(o=>{
      const price = typeof o.price_cents === 'number' ? o.price_cents/100 : null;
      return { ...o, _price: price };
    });
    if(sortByPrice){
      arr = arr.sort((a,b)=>{
        if(a._price == null && b._price == null) return 0;
        if(a._price == null) return 1;
        if(b._price == null) return -1;
        return a._price - b._price;
      });
    }

    arr.forEach(o=>{
    // build link buttons with distinct labels
    const canon = canonicalLink(o.store, o, state.identity);
    const buttons = [];
    if (o.url)   buttons.push(`<a class="btn" href="${o.url}" target="_blank" rel="noopener">Link</a>`);
    if (canon)    buttons.push(`<a class="btn" href="${canon}" target="_blank" rel="noopener">Canonical</a>`);

    const linksHtml = `<div class="links-compact">${buttons.join('')}</div>`;


      const skuLine = o.store_sku ? `${o.store_sku}` : '';
      const row = document.createElement('div');
      row.className = 'offer';
      row.innerHTML = `
        <div>
          <strong>${titleCase(o.store || '')}</strong>
          <div class="muted">${skuLine}</div>
        </div>
        <div class="muted">
          ${o._price != null ? `${fmt.format(o._price)}` : 'No price'}
        </div>
        <div>${linksHtml}</div>
      `;
      wrap.appendChild(row);
    });

    note.textContent = "Link is the specific listing we captured. Canonical is the retailer's main product page for the same item.";
  }

    function renderVariants(){
      const sel = $('#variant'); sel.innerHTML = '';
      const list = Array.isArray(state.variants) ? state.variants : [];

      if (!list.length) {
        const opt = document.createElement('option');
        opt.value = 'Default';
        opt.textContent = 'Default';
        sel.appendChild(opt);
        return;
      }

      for (const v of list){
        const opt = document.createElement('option');
        opt.value = v.asin || v.model_number || v.variant_label || 'Variant';
        opt.textContent = v.variant_label || v.model_number || v.asin || 'Variant';
        if (v.asin) opt.dataset.asin = v.asin;

        // keep selection
        const asinU = (v.asin || '').toUpperCase();
        opt.selected = !!(state.selectedAsin && asinU === state.selectedAsin);

        sel.appendChild(opt);
      }
    }


  function renderForensics(){
    const ul = $('#forensicsList'); ul.innerHTML = '';
    ['Strike is consistent with recent range for this variant',
     'Variant IDs match',
     'Anchor price looks reasonable'].forEach(t=>{
       const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);
     });
  }

  function renderObs(){
    const body = $('#obsBody'); body.innerHTML='';
    if(!state.observed.length) return;
    state.observed
      .slice()
      .sort((a,b)=> new Date(b.t).getTime() - new Date(a.t).getTime())
      .forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${new Intl.DateTimeFormat(undefined,{dateStyle:'medium',timeStyle:'short'}).format(new Date(o.t))}</td>
          <td>${titleCase(o.store || '')}</td>
          <td>${typeof o.price_cents === 'number' ? fmt.format(o.price_cents/100) : ''}</td>
          <td class="muted">${o.note || ''}</td>
        `;
        body.appendChild(tr);
      });
  }

  function renderCoverage(){
    const div = $('#coverage'); div.innerHTML = '';
    const order = ['amazon','target','walmart','bestbuy'];
    const present = new Set((state.offers || []).map(o => (o.store || '').toLowerCase()));
    const activeCount = order.filter(s => present.has(s)).length;
    const pct = activeCount ? Math.round(100 / activeCount) : 0;

    order.forEach(s => {
      const label = s === 'bestbuy' ? 'Best Buy'
                  : s === 'walmart' ? 'Walmart'
                  : s === 'target'  ? 'Target'
                  : 'Amazon';

      const isActive = present.has(s);
      const width = isActive ? pct : 0;
      const right = isActive ? `${pct}%` : `0%`;

      const row = document.createElement('div');
      row.className = 'bar';
      row.innerHTML = `
        <div>${label}</div>
        <div class="track"><div class="fill" style="width:${width}%"></div></div>
        <div>${right}</div>
      `;
      div.appendChild(row);
    });

    requestAnimationFrame(() => {
      const fills = Array.from(div.querySelectorAll('.fill'));
      fills.forEach(f => {
        const w = f.style.width;
        f.style.width = '0%';
        void f.offsetWidth;
        f.style.transition = 'width .9s ease';
        f.style.width = w;
      });
    });
  }

  function getCheapestOffer(){
    const arr = (state.offers||[]).map(o=>({ ...o, total:o.price_cents }));
    const has = arr.filter(x=>typeof x.total === 'number');
    if(!has.length) return null;
    has.sort((a,b)=>a.total - b.total);
    return has[0];
  }

  function buildSummaryMsg(){
    if(!state.identity) return null;
    const id = state.identity;
    const best = getCheapestOffer();
    const lines = [];
    lines.push(`PriceCheck summary`);
    lines.push(`IDs: UPC ${id.upc || 'NA'}  ASIN ${id.asin || 'NA'}`);
    if(best){
      const bestLink = best.url || canonicalLink(best.store, best, id) || '';
      lines.push(`Best: ${titleCase(best.store)} ~ ${fmt.format((best.price_cents||0)/100)}${bestLink?` (${bestLink})`:''}`);
    }
    lines.push(`Stores:`);
    (state.offers||[]).forEach(o=>{
      const link = o.url || canonicalLink(o.store, o, id) || '';
      const price = typeof o.price_cents === 'number' ? fmt.format(o.price_cents/100) : 'NA';
      lines.push(`• ${titleCase(o.store||'')} ${price}${link?` (${link})`:''}`);
    });
    return lines.join('\n');
  }

  function buildRefundMsg(){
    if(!state.identity) return null;
    const d = state.identity;
    const cheap = getCheapestOffer();
    return [
      `Hello. I recently bought this item and saw a lower price. Requesting post purchase adjustment.`,
      `Lower price: ${cheap ? `${titleCase(cheap.store)} ~ ${fmt.format((cheap.price_cents||0)/100)} ${cheap.url?`(${cheap.url})`:''}` : '[enter link]'}`,
      `IDs: UPC ${d.upc||'NA'} ASIN ${d.asin||'NA'}.`
    ].join('\n');
  }

  function buildFlagMsg(){
    if(!state.identity) return null;
    const cheap = getCheapestOffer();
    return [
      `Please review a suspicious listing.`,
      `Example: ${cheap ? `${titleCase(cheap.store)} ${cheap.url?cheap.url:''}` : '[link]'}`,
      `Reason: price looks off or marketplace seller.`
    ].join('\n');
  }

  function downloadHistoryCsv(){
    const rows = [['date','price','typical_low']];
    const csv = rows.map(r=>r.map(v=>String(v)).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'history.csv';
    document.body.appendChild(a); a.click(); a.remove();
  }

  function downloadObsCsv(){
    const rows = [['time','store','price','note']];
    (state.observed||[]).forEach(o=>{
      rows.push([
        o.t ? new Date(o.t).toISOString() : '',
        o.store || '',
        typeof o.price_cents === 'number' ? (o.price_cents/100).toFixed(2) : '',
        (o.note || '').replace(/,/g,';')
      ]);
    });
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'observations.csv';
    document.body.appendChild(a); a.click(); a.remove();
  }

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderSpecsMatrix(){
    const host = $('#specsMatrix');
    host.innerHTML = '';
    const items = Array.isArray(state.variants) ? state.variants : [];
    if (!items.length){ host.textContent = 'No specs available.'; return; }

    const cols = [
      ['variant', 'Variant'],
      ['category', 'Category'],
      ['brand', 'Brand'],
      ['model_number', 'Model Number'],
      ['model_name', 'Model Name'],
    ];

    const varies = {};
    ['category','brand','model_number','model_name'].forEach(k=>{
      const vals = new Set(items.map(v => (v[k] || '').trim()));
      varies[k] = vals.size > 1;
    });

    let html = '<table><thead><tr>';
    cols.forEach(([,label]) => { html += `<th>${label}</th>`; });
    html += '</tr></thead><tbody>';

    items.forEach(v=>{
      html += '<tr>';
      const label = v.variant_label || v.model_name || v.model_number || v.asin || 'Variant';
      html += `<td class="mono">${escapeHtml(label)}</td>`;

      ['category','brand','model_number','model_name'].forEach(k=>{
        const val = v[k] || 'NA';
        const hi = varies[k] ? ' style="background:rgba(255,230,150,.45)"' : '';
        html += `<td${hi}>${escapeHtml(val)}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    host.innerHTML = html;
  }

  function note(t){
    const n = document.getElementById('actNote'); if(!n) return;
    n.textContent = t; setTimeout(()=>{ n.textContent=''; }, 1200);
  }
  function copyText(s){
    const ta = document.createElement('textarea'); ta.value = s;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }
  function titleCase(s){ return String(s||'').replace(/\b\w/g, c=>c.toUpperCase()); }
  function flip(sel,on,off,ms){ const el=$(sel); const txt=el.textContent; el.textContent=on; setTimeout(()=>el.textContent=off||txt,ms||900); }
})();
</script>

</body>
</html>
